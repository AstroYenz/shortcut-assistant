import {logError, sleep} from '../utils/utils'


export class CommentBox{
    static resizeTextareaToFitContent(textarea){
        textarea.style.height = 'auto'
        textarea.style.height = textarea.scrollHeight + 'px'
    }

    static async getCommentBox(){
        const commentBox = document.querySelector('.textfield')
        let inputFieldParent = document.querySelector('[data-on-mouseup="App.Controller.Comment.handleOnMouseUp"]')
        if (commentBox && !inputFieldParent) {
            commentBox.click()
            await sleep(100)
            inputFieldParent = document.querySelector('[data-on-mouseup="App.Controller.Comment.handleOnMouseUp"]')
        }
        return inputFieldParent
    }

    static async populate(response){
        if (response === undefined) {
            return
        }

        const commentBox = await this.getCommentBox()
        const content = '✨ Generated by Story Readiness Assistant GPT ✨\n\n'
        if (!commentBox.value.includes(content)) {
            commentBox.value = content
        }
        commentBox.value = commentBox.value + response
        this.resizeTextareaToFitContent(commentBox)
    }

    static async clear(){
        const commentBox = await this.getCommentBox()
        commentBox.value = ''
        this.resizeTextareaToFitContent(commentBox)
    }
}


chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    if (request.type === 'updateOpenAiResponse') {
        if (request.data !== undefined) {
            CommentBox.populate(request.data).catch(logError)
        }
    }
    if (request.type === 'OpenAIResponseFailed') {
        CommentBox.clear().catch(logError)
    }
})