import {sleep} from "../utils";

function extractStoryDescription() {
    const descriptionDiv = document.querySelector('[data-key="description"]');
    return descriptionDiv.textContent
}

function resizeTextareaToFitContent(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

async function populateCommentBox(response) {
    const commentBox = document.querySelector('.textfield');
    if (commentBox) {
        commentBox.click()
        await sleep(100)
        const inputFieldParent = document.querySelector('[data-on-mouseup="App.Controller.Comment.handleOnMouseUp"]');
        const content = '✨ Generated by Story Readiness Assistant GPT ✨\n\n' + response;
        if (!inputFieldParent.value.includes(content)) {
            inputFieldParent.value = content;
        }
        resizeTextareaToFitContent(inputFieldParent)
        chrome.runtime.sendMessage({message: 'OpenAIResponseCompleted'})
    }
}

async function analyzeStoryDescription(activeTabUrl) {
    if (activeTabUrl.includes('story')) {
        const description = extractStoryDescription()
        const response = await chrome.runtime.sendMessage({action: 'callOpenAI', data: {prompt: description}})
        populateCommentBox(response.data).catch((error) => {
            console.error(error)
        });
    }
}

chrome.runtime.onMessage.addListener(
    async function (request, sender, sendResponse) {
    const activeTabUrl = window.location.href
    if (request.message === 'analyzeStoryDescription') {
        await analyzeStoryDescription(activeTabUrl);
    }
});
